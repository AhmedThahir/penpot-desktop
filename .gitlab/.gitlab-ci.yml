Prepare:
  tags:
    - main
  stage: .pre
  only:
    - production
  script:
    - if [ -d "dist/" ]; then rm -R dist/; fi # Delete the dist/ folder if it exist
    - export $(grep -v '^#' .env | xargs)
    - mkdir /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/$VERSION/

# Build
Windows:
  tags:
    - main
  stage: build
  only:
    - production
  script:
    - yarn
    - yarn build:win
    - cp dist/Penpot*.exe /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/.prepare/
    - cp dist/latest.yml /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/.prepare/

Mac:
  variables:
    GIT_STRATEGY: none # Due to OS being isolated in a VM in certain conditions, conflicts will rise
  tags:
    - mac
  stage: build
  only:
    - production
  script:
    - echo "Hi, I'm a Mac."
    - sleep 2
    - cd /Users/korbs/Documents/
    - git clone http://192.168.1.195:5050/code/Korbs/Penpot-Desktop/
    - cd Penpot-Desktop
    - git checkout main
    - yarn
    - yarn build
    - mv dist/Penpot*.dmg dist/Penpot.dmg
    - lftp -u $SFTP_USERNAME,$SFTP_PASSWORD $SFTP_IP -e "set ftp:ssl-allow off; cd /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/.prepare/; put dist/Penpot.dmg; bye;"
    - cd ..
    - rm -r Penpot-Desktop # Clean up for next run

Linux:
  tags:
    - main
  stage: build
  only:
    - production
  script:
    - yarn
    - yarn build
    - cp dist/*.deb /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/.prepare/
    - cp dist/*.rpm /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/.prepare/

# Deploy
Windows-Ready:
  tags:
    - main
  stage: deploy
  only:
    - production
  needs:
    - job: Prepare
    - job: Windows
  script:
    - export $(grep -v '^#' .env | xargs)
    - cd /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/.prepare/
    - cp Penpot*.exe /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/latest/
    - cp latest.yml /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/latest/
    - cp Penpot*.exe /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/$VERSION/

Mac-Ready:
  tags:
    - main
  stage: deploy
  only:
    - production
  needs:
    - job: Mac
  dependencies: 
    - Mac
  script:
    - export $(grep -v '^#' .env | xargs)
    - cd /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/.prepare/
    - cp Penpot.dmg /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/latest/
    - cp Penpot.dmg /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/$VERSION/

Linux-Ready:
  tags:
    - main
  stage: deploy
  only:
    - production
  needs:
    - job: Prepare
    - job: Linux
  script:
    - export CLOUDSMITH_API_KEY=$CLOUDSMITH_API_KEY
    - cd /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/.prepare/
    - cloudsmith push rpm korbsstudio/penpot-desktop/any-distro/any-version *.rpm
    - cloudsmith push deb korbsstudio/penpot-desktop/any-distro/any-version *.deb
    - sleep 24
    - rm /korbs-studio-server/nginx/sites/distribute/applications/penpot-desktop/.prepare/*